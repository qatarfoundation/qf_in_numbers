import{Loader as e}from"@/vendor/resource-loader";import{FileLoader as r,CompressedTexture as t,UnsignedByteType as o,LinearFilter as n,CubeTexture as a,LinearMipmapLinearFilter as i,Loader as s,RGBAFormat as c,RGBA_ASTC_4x4_Format as u,RGBA_BPTC_Format as d,RGBA_ETC2_EAC_Format as l,RGBA_PVRTC_4BPPV1_Format as f,RGBA_S3TC_DXT5_Format as h,RGB_ETC1_Format as p,RGB_ETC2_Format as m,RGB_PVRTC_4BPPV1_Format as g,RGB_S3TC_DXT1_Format as _}from"three";function T(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function w(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function y(e,r,t){return r&&w(e.prototype,r),t&&w(e,t),e}function B(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function v(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function C(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?v(Object(t),!0).forEach((function(r){B(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):v(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function b(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&E(e,r)}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function E(e,r){return(E=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function P(e,r){return!r||"object"!=typeof r&&"function"!=typeof r?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):r}function A(e){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,o=S(e);if(r){var n=S(this).constructor;t=Reflect.construct(o,arguments,n)}else t=o.apply(this,arguments);return P(this,t)}}function F(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var t=[],o=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(o=(i=s.next()).done)&&(t.push(i.value),!r||t.length!==r);o=!0);}catch(e){n=!0,a=e}finally{try{o||null==s.return||s.return()}finally{if(n)throw a}}return t}(e,r)||function(e,r){if(!e)return;if("string"==typeof e)return R(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return R(e,r)}(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,o=new Array(r);t<r;t++)o[t]=e[t];return o}var x=new WeakMap,k=function(e){b(u,s);var c=A(u);function u(e){var r;return T(this,u),(r=c.call(this,e)).transcoderPath="",r.transcoderBinary=null,r.transcoderPending=null,r.workerLimit=4,r.workerPool=[],r.workerNextTaskID=1,r.workerSourceURL="",r.workerConfig=null,r}return y(u,[{key:"setTranscoderPath",value:function(e){return this.transcoderPath=e,this}},{key:"setWorkerLimit",value:function(e){return this.workerLimit=e,this}},{key:"detectSupport",value:function(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}},{key:"load",value:function(e,o,n,a){var i=this,s=new r(this.manager);s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);var c=new t;return s.load(e,(function(e){if(x.has(e))return x.get(e).promise.then(o).catch(a);i._createTexture([e]).then((function(e){e.constructor!==c.constructor&&(c=new e.constructor),c.copy(e),c.needsUpdate=!0,o&&o(c)})).catch(a)}),n,a),c}},{key:"parseInternalAsync",value:function(e){for(var r=e.levels,t=new Set,o=0;o<r.length;o++)t.add(r[o].data.buffer);return this._createTexture(Array.from(t),C(C({},e),{},{lowLevel:!0}))}},{key:"_createTexture",value:function(e){for(var r,s,c=this,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},d=u,l=0,f=0;f<e.length;f++)l+=e[f].byteLength;var h=this._allocateWorker(l).then((function(t){return r=t,s=c.workerNextTaskID++,new Promise((function(t,o){r._callbacks[s]={resolve:t,reject:o},r.postMessage({type:"transcode",id:s,buffers:e,taskConfig:d},e)}))})).then((function(e){var r=e.mipmaps,s=e.cubeImages,c=e.width,u=e.height,d=e.format;if(s){for(var l=[],f=0;f<s.length;f++){var h=new t([s[f]],c,u,d,o);h.minFilter=n,h.magFilter=n,h.generateMipmaps=!1,h.needsUpdate=!0,l.push(h)}var p=new a(l);return p.minFilter=l[0].minFilter,p.magFilter=l[0].magFilter,p.format=l[0].format,p.encoding=l[0].encoding,p.generateMipmaps=!1,p.needsUpdate=!0,p}var m=new t(r,c,u,d,o);return m.minFilter=1===r.length?n:i,m.magFilter=n,m.generateMipmaps=!1,m.needsUpdate=!0,m}));return h.catch((function(){return!0})).then((function(){r&&s&&(r._taskLoad-=l,delete r._callbacks[s])})),x.set(e[0],{promise:h}),h}},{key:"_initTranscoder",value:function(){var e=this;if(!this.transcoderPending){var t=new r(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);var o=new Promise((function(e,r){t.load("basis_transcoder.js",e,void 0,r)})),n=new r(this.manager);n.setPath(this.transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);var a=new Promise((function(e,r){n.load("basis_transcoder.wasm",e,void 0,r)}));this.transcoderPending=Promise.all([o,a]).then((function(r){var t=F(r,2),o=t[0],n=t[1],a=u.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(u.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(u.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(u.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([i])),e.transcoderBinary=n}))}return this.transcoderPending}},{key:"_allocateWorker",value:function(e){var r=this;return this._initTranscoder().then((function(){if(r.workerPool.length<r.workerLimit){var t=new Worker(r.workerSourceURL);t._callbacks={},t._taskLoad=0,t.postMessage({type:"init",config:r.workerConfig,transcoderBinary:r.transcoderBinary}),t.onmessage=function(e){var r=e.data;switch(r.type){case"transcode":t._callbacks[r.id].resolve(r);break;case"error":t._callbacks[r.id].reject(r);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+r.type+'"')}},r.workerPool.push(t)}else r.workerPool.sort((function(e,r){return e._taskLoad>r._taskLoad?-1:1}));var o=r.workerPool[r.workerPool.length-1];return o._taskLoad+=e,o}))}},{key:"dispose",value:function(){for(var e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}]),u}();k.BasisFormat={ETC1S:0,UASTC_4x4:1},k.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},k.EngineFormat={RGBAFormat:c,RGBA_ASTC_4x4_Format:u,RGBA_BPTC_Format:d,RGBA_ETC2_EAC_Format:l,RGBA_PVRTC_4BPPV1_Format:f,RGBA_S3TC_DXT5_Format:h,RGB_ETC1_Format:p,RGB_ETC2_Format:m,RGB_PVRTC_4BPPV1_Format:g,RGB_S3TC_DXT1_Format:_},k.BasisWorker=function(){var e,r,t,o=_EngineFormat,n=_TranscoderFormat,a=_BasisFormat;onmessage=function(o){var n,i=o.data;switch(i.type){case"init":e=i.config,n=i.transcoderBinary,r=new Promise((function(e){t={wasmBinary:n,onRuntimeInitialized:e},BASIS(t)})).then((function(){t.initializeBasis()}));break;case"transcode":r.then((function(){try{var e=i.taskConfig.lowLevel?function(e){var r=e.basisFormat,o=e.width,n=e.height,i=e.hasAlpha,s=u(r,o,n,i),c=s.transcoderFormat,p=s.engineFormat,m=t.getBytesPerBlockOrPixel(c);d(t.isFormatSupported(c),"THREE.BasisTextureLoader: Unsupported format.");var g=[];if(r===a.ETC1S){var _=new t.LowLevelETC1SImageTranscoder,T=e.globalData,w=T.endpointCount,y=T.endpointsData,B=T.selectorCount,v=T.selectorsData,C=T.tablesData;try{d(_.decodePalettes(w,y,B,v),"THREE.BasisTextureLoader: decodePalettes() failed."),d(_.decodeTables(C),"THREE.BasisTextureLoader: decodeTables() failed.");for(var b=0;b<e.levels.length;b++){var S=e.levels[b],E=e.globalData.imageDescs[b],P=h(c,S.width,S.height),A=new Uint8Array(P);d(_.transcodeImage(c,A,P/m,S.data,l(c,S.width),f(c,S.height),S.width,S.height,S.index,E.rgbSliceByteOffset,E.rgbSliceByteLength,E.alphaSliceByteOffset,E.alphaSliceByteLength,E.imageFlags,i,!1,0,0),"THREE.BasisTextureLoader: transcodeImage() failed for level "+S.index+"."),g.push({data:A,width:S.width,height:S.height})}}finally{_.delete()}}else for(var F=0;F<e.levels.length;F++){var R=e.levels[F],x=h(c,R.width,R.height),k=new Uint8Array(x);d(t.transcodeUASTCImage(c,k,x/m,R.data,l(c,R.width),f(c,R.height),R.width,R.height,R.index,0,R.data.byteLength,0,i,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+R.index+"."),g.push({data:k,width:R.width,height:R.height})}return{width:o,height:n,hasAlpha:i,mipmaps:g,format:p}}(i.taskConfig):function(e){var r=new t.BasisFile(new Uint8Array(e)),o=r.isUASTC()?a.UASTC_4x4:a.ETC1S,n=r.getImageWidth(0,0),i=r.getImageHeight(0,0),s=r.getNumLevels(0),c=r.getHasAlpha(),d=r.getNumImages();function l(){r.close(),r.delete()}var f=u(o,n,i,c),h=f.transcoderFormat,p=f.engineFormat;if(!n||!i||!s)throw l(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!r.startTranscoding())throw l(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");if(1===d){for(var m=[],g=0;g<s;g++){var _=r.getImageWidth(0,g),T=r.getImageHeight(0,g),w=new Uint8Array(r.getImageTranscodedSizeInBytes(0,g,h));if(!r.transcodeImage(w,0,g,h,0,c))throw l(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");m.push({data:w,width:_,height:T})}return l(),{width:n,height:i,hasAlpha:c,mipmaps:m,format:p}}if(6===d){for(var y=[],B=0;B<d;B++){var v=0,C=r.getImageWidth(B,v),b=r.getImageHeight(B,v),S=new Uint8Array(r.getImageTranscodedSizeInBytes(B,v,h));if(!r.transcodeImage(S,B,v,h,0,c))throw l(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");y.push({data:S,width:C,height:b})}return l(),{width:n,height:i,hasAlpha:c,cubeImages:y,format:p}}throw new Error("THREE.BasisTextureLoader: Array textures are not currently supported.")}(i.buffers[0]),r=e.width,o=e.height,n=e.hasAlpha,s=e.mipmaps,c=e.cubeImages,p=e.format,m=[];if(c){for(var g=0;g<c.length;g++)m.push(c[g].data.buffer);self.postMessage({type:"transcode",id:i.id,width:r,height:o,hasAlpha:n,cubeImages:c,format:p},m)}else{for(var _=0;_<s.length;++_)m.push(s[_].data.buffer);self.postMessage({type:"transcode",id:i.id,width:r,height:o,hasAlpha:n,mipmaps:s,format:p},m)}}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}}))}};var i=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC1,n.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC1],engineFormat:[o.RGB_ETC1_Format,o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],s=i.sort((function(e,r){return e.priorityETC1S-r.priorityETC1S})),c=i.sort((function(e,r){return e.priorityUASTC-r.priorityUASTC}));function u(r,t,i,u){for(var d=r===a.ETC1S?s:c,l=0;l<d.length;l++){var f=d[l];if(e[f.if]&&(f.basisFormat.includes(r)&&(!f.needsPowerOfTwo||p(t)&&p(i))))return{transcoderFormat:f.transcoderFormat[u?1:0],engineFormat:f.engineFormat[u?1:0]}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:n.RGBA32,engineFormat:o.RGBAFormat}}function d(e,r){if(!e)throw new Error(r)}function l(e,r){return Math.ceil(r/t.getFormatBlockWidth(e))}function f(e,r){return Math.ceil(r/t.getFormatBlockHeight(e))}function h(e,r,o){var a=t.getBytesPerBlockOrPixel(e);if(t.formatIsUncompressed(e))return r*o*a;if(e===n.PVRTC1_4_RGB||e===n.PVRTC1_4_RGBA){var i=r+3&-4,s=o+3&-4;return(Math.max(8,i)*Math.max(8,s)*4+7)/8}return l(e,r)*f(e,o)*a}function p(e){return e<=2||0==(e&e-1)&&0!==e}};var O=function(r){b(o,e);var t=A(o);function o(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(T(this,o),(e=t.call(this,r))._loader=new k,e._transcoderPath=r.transcoderPath,e._renderer=r.renderer,!e._transcoderPath)throw new Error("ThreeBasisTextureLoader: transcoderPath is not defined");if(!e._renderer)throw new Error("ThreeBasisTextureLoader: renderer is not defined");return e._loader.setTranscoderPath(e._transcoderPath),e._loader.detectSupport(e._renderer),e}return y(o,[{key:"load",value:function(e){var r=this,t=e.path;return new Promise((function(e,o){r._loader.load(t,e,null,o)}))}}]),o}();export default O;
